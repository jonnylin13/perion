<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>packages/crypto/src/aes.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-@perion_calc.HyperStats.html">HyperStats</a><ul class='methods'><li data-type='method'><a href="module-@perion_calc.HyperStats.html#.from">from</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyAll">applyAll</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyArcaneForce">applyArcaneForce</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyBonusExp">applyBonusExp</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyBossDmg">applyBossDmg</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyCrit">applyCrit</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyCritDmg">applyCritDmg</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyDmg">applyDmg</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyIgnoreDef">applyIgnoreDef</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyMagicAtt">applyMagicAtt</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyMaxDF">applyMaxDF</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyMaxHP">applyMaxHP</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyMaxMP">applyMaxMP</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyMaxTF">applyMaxTF</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyPureStats">applyPureStats</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyStance">applyStance</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyStatusResist">applyStatusResist</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#applyWeaponAtt">applyWeaponAtt</a></li><li data-type='method'><a href="module-@perion_calc.HyperStats.html#get">get</a></li></ul></li><li><a href="module-@perion_core.Cast.html">Cast</a><ul class='methods'><li data-type='method'><a href="module-@perion_core.Cast.html#.from">from</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#float32">float32</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#float64">float64</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#int8">int8</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#int16">int16</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#int32">int32</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#int64">int64</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#short">short</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#uint8">uint8</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#uint16">uint16</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#uint32">uint32</a></li><li data-type='method'><a href="module-@perion_core.Cast.html#ushort">ushort</a></li></ul></li><li><a href="module-@perion_crypto.AES.html">AES</a><ul class='methods'><li data-type='method'><a href="module-@perion_crypto.AES.html#._morph">_morph</a></li><li data-type='method'><a href="module-@perion_crypto.AES.html#.morphIV">morphIV</a></li><li data-type='method'><a href="module-@perion_crypto.AES.html#.scaleIV">scaleIV</a></li><li data-type='method'><a href="module-@perion_crypto.AES.html#_getPacketLength">_getPacketLength</a></li><li data-type='method'><a href="module-@perion_crypto.AES.html#_transform">_transform</a></li><li data-type='method'><a href="module-@perion_crypto.AES.html#getPacketHeader">getPacketHeader</a></li><li data-type='method'><a href="module-@perion_crypto.AES.html#transform">transform</a></li></ul></li><li><a href="module-@perion_crypto.Shanda.html">Shanda</a><ul class='methods'><li data-type='method'><a href="module-@perion_crypto.Shanda.html#.decrypt">decrypt</a></li><li data-type='method'><a href="module-@perion_crypto.Shanda.html#.encrypt">encrypt</a></li><li data-type='method'><a href="module-@perion_crypto.Shanda.html#.rol">rol</a></li><li data-type='method'><a href="module-@perion_crypto.Shanda.html#.ror">ror</a></li></ul></li><li><a href="module-@perion_net.Encoder.html">Encoder</a><ul class='methods'><li data-type='method'><a href="module-@perion_net.Encoder.html#.decode">decode</a></li><li data-type='method'><a href="module-@perion_net.Encoder.html#.encode">encode</a></li></ul></li><li><a href="module-@perion_net.Parser.html">Parser</a><ul class='methods'><li data-type='method'><a href="module-@perion_net.Parser.html#ascii">ascii</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#bool">bool</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#byte">byte</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#char">char</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#collect">collect</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#double">double</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#get">get</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#int">int</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#long">long</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#mapleascii">mapleascii</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#nullascii">nullascii</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#pos">pos</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#read">read</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#seek">seek</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#short">short</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#skip">skip</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#ubyte">ubyte</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#uint">uint</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#ulong">ulong</a></li><li data-type='method'><a href="module-@perion_net.Parser.html#ushort">ushort</a></li></ul></li><li><a href="module-@perion_net.Writer.html">Writer</a><ul class='methods'><li data-type='method'><a href="module-@perion_net.Writer.html#ascii">ascii</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#bool">bool</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#buffer">buffer</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#byte">byte</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#dynamicAlloc">dynamicAlloc</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#int">int</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#long">long</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#mapleascii">mapleascii</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#nullascii">nullascii</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#pos">pos</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#short">short</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#ubyte">ubyte</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#uint">uint</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#ulong">ulong</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#ushort">ushort</a></li><li data-type='method'><a href="module-@perion_net.Writer.html#write">write</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-@perion_calc.html">@perion/calc</a></li><li><a href="module-@perion_core.html">@perion/core</a></li><li><a href="module-@perion_crypto.html">@perion/crypto</a></li><li><a href="module-@perion_net.html">@perion/net</a></li><li><a href="module-@perion_perion.html">@perion/perion</a></li><li><a href="module-@perion_wz.html">@perion/wz</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">packages/crypto/src/aes.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const crypto = require('crypto');
const {KEYS, SHIFT_KEYS} = require('./constants.js');
/**
 * A MapleStory implementation of AES-256-ECB
 * @class
 * @memberof module:@perion/crypto
 */
class AES {
  /**
   * AES class constructor
   * @constructor
   * @param {Buffer} iv The initialization vector
   * @param {number} mapleVersion MapleStory version
   */
  constructor(iv, mapleVersion) {
    this.iv = iv;
    const left = (mapleVersion >> 8) &amp; 0xff;
    const right = (mapleVersion &lt;&lt; 8) &amp; 0xff00;
    this.maskedVersion = left | right;
    this.mapleVersion = mapleVersion;
  }
  /**
   * Generates the packet header using the current IV
   * @param {number} length The length of the packet data
   * @return {Buffer} The packet header Buffer
   */
  getPacketHeader(length) {
    let a = (this.iv[3] &amp; 0xff);
    a |= (this.iv[2] &lt;&lt; 8) &amp; 0xff00;
    a ^= this.maskedVersion;
    const b = a ^ (((length &lt;&lt; 8) &amp; 0xff00) | length >>> 8);
    const header = Buffer.from([
      (a >>> 8) &amp; 0xff,
      a &amp; 0xff,
      (b >>> 8) &amp; 0xff,
      b &amp; 0xff,
    ]);
    return header;
  }
  /**
   * Gets the packet length using the header
   * @param {number} header The packet header as an int32
   * @return {number} The packet length
   */
  _getPacketLength(header) {
    let packetLength = ((header >>> 16) ^ (header &amp; 0xffff));
    packetLength = ((header &lt;&lt; 8) &amp; 0xff00) | ((packetLength >>> 8) &amp; 0xff);
    return packetLength;
  }
  /**
   * Transforms the data payload using the current IV
   * Will morph the IV after use.
   * @param {Buffer} data The input data Buffer
   * @return {Buffer} Returns the transformed data
   */
  transform(data) {
    const {length} = data;
    const key = KEYS[this.mapleVersion];
    /** MapleStory's 1460 byte block */
    const blockLength = 1460;
    /** Subtract 4 bytes for the packet header */
    let currentBlockLength = 1456;
    const ivScaled = AES.scaleIV(this.iv, 4, 4);
    const cipher = crypto.createCipheriv('aes-256-ecb', key, null);
    for (let i = 0; i &lt; length;) {
      const block = Math.min(length - i, currentBlockLength);
      let xorKey = ivScaled.slice();
      for (let j = 0; j &lt; block; j++) {
        if (j % 16 === 0) {
          xorKey = Buffer.concat([cipher.update(xorKey), cipher.final()]);
        }
        data[i + j] ^= xorKey[j % 16];
      }
      i += block;
      currentBlockLength = blockLength;
    }
    this.iv = AES.morphIV(this.iv, this.mapleVersion);
    return data;
  }
  /**
   * Old implementation of transform(data)
   * Will morph the IV after use.
   * Use transform(data) instead.
   * @deprecated
   * @param {Buffer} data The input data buffer
   * @return {Buffer} Returns the transformed data
   */
  _transform(data) {
    const key = KEYS[this.mapleVersion];
    let remaining = data.length;
    let chunkLength = 0x5B0;
    let start = 0;
    while (remaining > 0) {
      let scaledIV = AES.scaleIV(this.iv, 4, 4);
      if (remaining &lt; chunkLength) {
        chunkLength = remaining;
      }
      for (let x = start; x &lt; (start + chunkLength); x++) {
        if ((x - start) % scaledIV.length === 0) {
          const cipher = crypto.createCipheriv('aes-256-ecb', key, null);
          scaledIV = Buffer.concat([cipher.update(scaledIV), cipher.final()]);
        }
        data[x] ^= scaledIV[(x - start) % scaledIV.length];
      }
      start += chunkLength;
      remaining -= chunkLength;
      chunkLength = 0x5B4;
    }
    this.iv = AES.morphIV(this.iv, this.mapleVersion);
    return data;
  }
  /**
   * Scales the IV byte length by a multiplier
   * @static
   * @param {Buffer} iv The initialization vector
   * @param {number} count The byte count
   * @param {number} multiply The amount to multiply
   * @return {Buffer} Returns the scaled IV
   */
   static scaleIV(iv, count, multiply) {
    const length = count * multiply;
    const ret = Buffer.alloc(length);
    for (let i = 0; i &lt; length; i++) {
      ret[i] = iv[i % count];
    }
    return ret;
  }
  /**
   * Morphs the IV, called after the IV is used
   * @static
   * @param {Buffer} iv The initialization vector
   * @param {number} mapleVersion MapleStory version
   * @return {Buffer} The new IV sequence
   */
  static morphIV(iv, mapleVersion) {
    const newSequence = Buffer.from([0xf2, 0x53, 0x50, 0xc6]);
    const skey = SHIFT_KEYS[mapleVersion];
    for (let i = 0; i &lt; 4; i++) {
      /** TODO: Removed, needs to be reworked */
      // const inputByte = iv[i];
      // const tableInput = skey[inputByte];
      // newSequence[0] += skey[newSequence[1] - inputByte];
      // newSequence[1] -= newSequence[2] ^ tableInput;
      // newSequence[2] ^= skey[newSequence[3]] + inputByte;
      // newSequence[3] -= newSequence[0] - tableInput;
      // let val =
      //   (
      //     newSequence[0] |
      //     ((newSequence[1] &amp; 0xff) &lt;&lt; 8 |
      //     ((newSequence[2] &amp; 0xff) &lt;&lt; 16) |
      //     ((newSequence[3]) &amp; 0xff) &lt;&lt; 24)
      //   ) >>> 0;
      // let val2 = val >>> 0x1d;
      // val = (val &lt;&lt; 0x03) >>> 0;
      // val2 |= val;
      // newSequence[0] = val2 &amp; 0xff;
      // newSequence[1] = (val2 >> 8) &amp; 0xff;
      // newSequence[2] = (val2 >> 16) &amp; 0xff;
      // newSequence[3] = (val2 >> 24) &amp; 0xff;
      this._morph(iv[i], newSequence, skey);
    }
    return newSequence;
  }
  /**
   * Morphs the input byte
   * @static
   * @param {number} inputByte The input byte
   * @param {Buffer} newSequence The new sequence
   * @param {Buffer} shiftKey The shift key
   * @return {Buffer} The modfied Buffer
   */
  static _morph(inputByte, newSequence, shiftKey) {
    let t1 = newSequence[1];
    const t2 = inputByte;
    let t3 = shiftKey[t1 &amp; 0xFF];
    t3 -= inputByte;
    newSequence[0] += t3;
    t3 = newSequence[2];
    t3 ^= shiftKey[t2 &amp; 0xFF];
    t1 -= t3 &amp; 0xFF;
    newSequence[1] = t1;
    t1 = newSequence[3];
    t3 = t1;
    t1 -= newSequence[0] &amp; 0xFF;
    t3 = shiftKey[t3 &amp; 0xFF];
    t3 += inputByte;
    t3 ^= newSequence[2];
    newSequence[2] = t3;
    t1 += shiftKey[t2 &amp; 0xFF] &amp; 0xFF;
    newSequence[3] = t1;
    let merry = (newSequence[0]) &amp; 0xFF;
    merry |= (newSequence[1] &lt;&lt; 8) &amp; 0xFF00;
    merry |= (newSequence[2] &lt;&lt; 16) &amp; 0xFF0000;
    merry |= (newSequence[3] &lt;&lt; 24) &amp; 0xFF000000;
    let ret = merry;
    ret = ret >>> 0x1d;
    merry = merry &lt;&lt; 3;
    ret = ret | merry;
    newSequence[0] = (ret &amp; 0xFF);
    newSequence[1] = ((ret >> 8) &amp; 0xFF);
    newSequence[2] = ((ret >> 16) &amp; 0xFF);
    newSequence[3] = ((ret >> 24) &amp; 0xFF);
    return newSequence;
  }
}
module.exports = AES;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Mon Mar 22 2021 06:21:50 GMT-0700 (Pacific Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
